<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スペイン語チャットボックス</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #5a7cff;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
            --text: #2b2d42;
            --text-light: #4a4d6b;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --dark-text: #e6e6e6;
            --dark-text-light: #b8b8b8;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100vw;
            padding: 20px;
            font-size: 16px;
            transition: var(--transition);
            line-height: 1.6;
        }
        
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 60px 40px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            font-size: 1.2rem;
        }
        
        body.dark-mode .container {
            background-color: var(--dark-card);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .header {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: -0.5px;
        }
        
        body.dark-mode .header {
            color: var(--accent);
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 20px;
        }
        
        .dropdown {
            flex: 1;
            min-width: 0;
            position: relative;
        }
        
        select {
            width: 100%;
            padding: 15px 20px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary);
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            appearance: none;
            transition: var(--transition);
        }
        
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        body.dark-mode select {
            background-color: var(--dark-card);
            color: var(--dark-text);
            border-color: var(--accent);
        }
        
        .dropdown:after {
            content: "▼";
            font-size: 0.8rem;
            color: var(--primary);
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        body.dark-mode .dropdown:after {
            color: var(--accent);
        }
        
        .file-upload-row {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 20px;
        }
        
        .file-input-container {
            flex: 1;
            position: relative;
            min-width: 0;
        }
        
        .file-input-label {
            display: block;
            width: 100%;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .file-input-label:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .file-input-label:active {
            transform: translateY(0);
        }
        
        body.dark-mode .file-input-label {
            background-color: var(--accent);
        }
        
        body.dark-mode .file-input-label:hover {
            background-color: var(--primary-light);
        }
        
        #fileNameDisplay {
            font-size: 0.9rem;
            margin-top: 10px;
            color: var(--text-light);
            text-align: center;
        }
        
        body.dark-mode #fileNameDisplay {
            color: var(--dark-text-light);
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 0;
            border: 2px solid transparent;
        }
        
        .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--text-light);
        }
        
        body.dark-mode .btn:disabled {
            background-color: var(--dark-text-light);
        }
        
        body.dark-mode .btn {
            background-color: var(--accent);
        }
        
        body.dark-mode .btn:hover {
            background-color: var(--primary-light);
        }
        
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--dark);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .night-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        body.dark-mode .night-mode-toggle {
            background-color: var(--light);
            color: var(--dark);
        }

        /* READING MODE STYLES */
        .reading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            color: var(--text);
            z-index: 100;
            overflow: hidden;
            padding: 15px;
            box-sizing: border-box;
            transition: var(--transition);
        }
        
        body.dark-mode .reading-container {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
        
        /* Ensure all elements in reading mode respect dark mode */
        body.dark-mode .reading-header,
        body.dark-mode .reading-footer {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
        
        body.dark-mode .sentence-display {
            color: var(--dark-text);
        }
        
        body.dark-mode .fruit-toggle {
            background-color: var(--success);
        }
        
        body.dark-mode .exit-reading {
            background-color: var(--warning);
        }
        
        .reading-header {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            align-items: center;
            position: relative;
        }
        
        .page-counter {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }
        
        body.dark-mode .page-counter {
            color: var(--dark-text-light);
        }
        
        .exit-reading {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 15px;
            background-color: var(--warning);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .fruit-toggle {
            background-color: var(--warning);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0; /* Prevent button from growing */
            margin: 0 5px; /* Add some horizontal spacing */
        }
        
        .fruit-toggle.on {
            background-color: var(--success);
        }
        
        .reel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .fruit-name {
            font-size: 1.2rem;
            height: 30px;
            text-align: center;
            color: var(--primary);
            font-weight: bold;
            min-width: 100px;
        }
        
        .reading-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: calc(100% - 120px); /* Reduced to account for smaller footer */
            padding: 0 20px;
            overflow: hidden;
            margin-bottom: 60px; /* Space for fixed footer */
        }
        
        .sentence-row {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 10px 20px; /* More side padding */
            width: 100%;
            overflow: hidden;
            min-height: 0;
            box-sizing: border-box;
            max-height: 50vh; /* Prevent overlap with header/footer */
        }
        
        .sentence-row:first-child {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        body.dark-mode .sentence-row:first-child {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sentence-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            position: relative;
        }
        
        .play-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 10px;
        }
        
        /* Update the sentence display to take remaining space */
        .sentence-display {
            font-size: 5vw;
            line-height: 1.4;
            text-align: left;
            word-break: break-word;
            overflow: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 5px;
            box-sizing: border-box;
            white-space: normal;
            min-height: 0;
            flex: 1;
            max-height: 100%;
            text-overflow: ellipsis;
        }
        
        .reading-footer {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
            height: 60px; /* Reduced height */
            gap: 10px; /* Add space between items */
        }
        
        body.dark-mode .reading-footer {
            background-color: var(--dark-card);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }
        
        .nav-btn {
            flex-shrink: 0; /* Prevent buttons from growing */
            background-color: var(--primary);
            color: white;
            border: none;
            width: 50px; /* Reduced size */
            height: 50px; /* Reduced size */
            border-radius: 50%;
            font-size: 1.2rem; /* Smaller font */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            position: relative;
            z-index: 20;
            margin: 0 10px; /* Added some spacing */
        }
        
        .nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .nav-btn:active {
            transform: scale(0.98);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Translation Popup Styles */
        .translation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            background-color: var(--card-bg);
            color: var(--text);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 30px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode .translation-popup {
            background-color: var(--dark-card);
            color: var(--dark-text);
        }
        
        .language-label {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary);
            font-weight: bold;
        }
        
        body.dark-mode .language-label {
            color: var(--accent);
        }
        
        .translation-original {
            font-size: 2.5rem !important;
            margin-bottom: 20px !important;
            padding: 20px !important;
            background-color: rgba(0,0,0,0.05) !important;
            border-radius: 12px !important;
        }
        
        .translation-result {
            font-size: 2.5rem !important;
            padding: 20px !important;
            background-color: rgba(67, 97, 238, 0.1) !important;
            border-radius: 12px !important;
        }
        
        .translation-tts {
            font-size: 2rem !important;
            padding: 15px 25px !important;
            margin-top: 25px !important;
        }
        
        .translation-popup-header h3 {
            font-size: 2.5rem !important;
        }
        
        .translation-popup-close {
            width: 50px !important;
            height: 50px !important;
            font-size: 2rem !important;
        }
        
        .translation-popup.active {
            display: block;
        }
        
        .translation-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .translation-popup-close {
            background-color: var(--warning);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .translation-content {
            margin-bottom: 15px;
        }
        
        .translation-original {
            font-size: 1.5rem;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
        }
        
        .translation-result {
            font-size: 1.5rem;
            padding: 10px;
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
        }
        
        .translation-tts {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .translation-tts:hover {
            background-color: var(--secondary);
        }
        
        .translation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .translation-overlay.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .translation-popup {
                width: 95%;
                padding: 15px;
                max-height: 80vh;
            }
            
            .translation-original, .translation-result {
                font-size: 1.2rem !important;
                padding: 10px !important;
            }
            
            .translation-popup-header h3 {
                font-size: 1.5rem !important;
            }
            
            .translation-tts {
                font-size: 1rem !important;
                padding: 10px 15px !important;
            }
        }
        
        /* Fruit Game Styles */
        .fruit-game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .fruit-game {
            background-color: var(--card-bg);
            color: var(--text);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 800px;
            width: 90%;
            transition: var(--transition);
        }
        
        body.dark-mode .fruit-game {
            background-color: var(--dark-card);
            color: var(--dark-text);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .fruit-reels {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .fruit-reel {
            font-size: 8rem;  /* Increased from 4rem */
            width: 150px;     /* Increased from 100px */
            height: 150px;    /* Increased from 100px */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        
        body.dark-mode .fruit-reel {
            background-color: var(--dark-card);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Confetti animation */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-10px) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @media (max-width: 800px) {
            .sentence-display {
                font-size: 32px !important; /* Minimum readable size */
            }
            
            .controls-row, .file-upload-row {
                flex-direction: column;
            }
            
            select, .btn, .file-input-label {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .header {
                font-size: 2rem;
                margin-bottom: 20px;
            }
            
            .fruit-reels {
                flex-wrap: wrap;  /* Allow reels to wrap on small screens */
                gap: 10px;
            }
            
            .fruit-reel {
                font-size: 4rem;  /* Slightly smaller */
                width: 90px;      /* Reduced from 120px */
                height: 90px;     /* Reduced from 120px */
            }
            
            .reel-container {
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .sentence-row {
                flex-direction: row;
                align-items: center;
                padding: 5px;
            }
            
            .play-btn {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
                margin-right: 8px;
            }
            
            .sentence-display {
                font-size: 1.5rem !important;  /* Increased from 1rem */
                padding: 5px;
                line-height: 1.4;
                min-height: 60px;  /* Ensure enough space for tapping */
            }
            
            .sentence-row {
                min-height: 80px;  /* More space for each sentence */
            }
            
            .container {
                padding: 30px 20px;
                width: 100%;
            }
            
            .controls-row, .file-upload-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .header {
                font-size: 1.8rem;
                margin-bottom: 25px;
            }
            
            select, .btn, .file-input-label {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .night-mode-toggle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
        
        @media (min-width: 1280px) {
            .nav-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .reading-footer {
                height: 70px;
            }
            
            .reading-content {
                height: calc(100% - 130px);
                margin-bottom: 70px;
            }
        }
        
        /* Main container - only affects home screen */
        #mainContainer.container {
            width: 95%;
            max-width: 1200px; /* Increased from 800px */
            padding: 60px 40px; /* Increased padding */
            font-size: 1.2rem; /* Base font size increase */
        }
        
        /* Only target header in main container */
        #mainContainer .header {
            font-size: 4rem; /* Increased from 2.2rem */
            margin-bottom: 50px; /* Increased from 30px */
        }
        
        /* Only target dropdowns in main container */
        #mainContainer .controls-row {
            display: flex;
            flex-direction: column; /* Stack vertically */
            margin-bottom: 25px;
            gap: 30px; /* Increased gap */
        }
        
        #mainContainer select {
            padding: 25px 30px; /* Increased from 15px 20px */
            font-size: 1.8rem; /* Increased from 1rem */
            border-width: 3px; /* Thicker border */
        }
        
        #mainContainer .dropdown:after {
            font-size: 1.5rem; /* Increased from 0.8rem */
            right: 30px; /* Adjusted position */
        }
        
        /* Larger screens adjustment */
        @media (min-width: 1024px) {
            #mainContainer .header {
                font-size: 5rem;
                margin-bottom: 60px;
            }
            
            #mainContainer select {
                padding: 30px 35px;
                font-size: 2rem;
            }
            
            #mainContainer .dropdown:after {
                font-size: 2rem;
                right: 35px;
            }
        }
        
        /* Japanese specific styles */
        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .japanese-font {
            font-family: 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body>
    <button class="night-mode-toggle" id="nightModeToggle">🌙</button>
    <div class="container" id="mainContainer">
        <div class="header japanese-font">スペイン語チャットボックス</div>
        
        <div class="controls-row">
            <div class="dropdown">
                <select id="contentSelector" class="japanese-font">
                    <option value="">コンテンツを選択</option>
                    <option value="questions">質問</option>
                    <option value="stories">ストーリー</option>
                </select>
            </div>
            
            <div class="dropdown">
                <select id="storySelector" disabled class="japanese-font">
                    <option value="">ストーリーを選択</option>
                </select>
            </div>
        </div>
    </div>

    <!-- READING MODE CONTAINER -->
    <div class="reading-container" id="readingModeContainer" style="display: none;">
        <div class="reading-header">
            <div class="page-counter japanese-font">ページ <span id="currentPage">1</span> / <span id="totalPages">1</span></div>
            <button id="exitReading" class="exit-reading">X</button>
        </div>
        
        <div class="reading-content">
            <div class="sentence-row">
                <div class="sentence-controls">
                    <button id="playSpanish" class="play-btn">▶</button>
                    <div id="spanishSentence" class="sentence-display"></div>
                </div>
            </div>
            
            <div class="sentence-row">
                <div class="sentence-controls">
                    <button id="playJapanese" class="play-btn">▶</button>
                    <div id="japaneseSentence" class="sentence-display japanese-font"></div>
                </div>
            </div>
        </div>
        
        <div class="reading-footer">
            <button id="prevSentence" class="nav-btn">←</button>
            <button id="fruitToggle" class="fruit-toggle japanese-font">フルーツゲーム OFF</button>
            <button id="nextSentence" class="nav-btn">→</button>
        </div>
    </div>

    <!-- Translation Popup -->
    <div class="translation-overlay" id="translationOverlay"></div>
    <div class="translation-popup" id="translationPopup">
        <div class="translation-popup-header">
            <h3 class="japanese-font">翻訳</h3>
            <button class="translation-popup-close" id="closeTranslationPopup">×</button>
        </div>
        <div class="translation-content">
            <div class="language-label japanese-font" id="sourceLanguageLabel">スペイン語:</div>
            <div class="translation-original" id="translationOriginal"></div>
            
            <div class="language-label japanese-font" id="targetLanguageLabel">日本語:</div>
            <div class="translation-result japanese-font" id="translationResult"></div>
            
            <button class="translation-tts japanese-font" id="translationTts">
                <span>🔊 音声再生</span>
            </button>
        </div>
    </div>
    
    <script>
        // Spanish-Japanese content
        const spanishContent = {
            questions: `#QUESTIONS  
🐶¿Cómo te llamás?  
あなたの名前は何ですか？  
😊¿Cómo estás hoy?  
今日の調子はどうですか？  
🎂¿Cuántos años tienes?  
何歳ですか？  
🏠¿Dónde vives?  
どこに住んでいますか？  
👨‍👩‍👧‍👦¿Cuántas personas hay en tu familia?  
家族は何人ですか？  
🐱¿Tienes una mascota?  
ペットを飼っていますか？  
🌈¿Cuál es tu color favorito?  
好きな色は何ですか？  
🍎¿Te gustan las manzanas?  
リンゴは好きですか？  
🍕¿Cuál es tu comida favorita?  
好きな食べ物は何ですか？  
🎮¿Te gustan los videojuegos?  
テレビゲームは好きですか？  
⚽¿Practicas deportes?  
スポーツをしますか？  
📺¿Cuál es tu programa de TV favorito?  
好きなテレビ番組は何ですか？  
🎵¿Te gusta la música?  
音楽は好きですか？  
📚¿Te gusta leer libros?  
本を読むのは好きですか？  
✏️¿Cuál es tu materia favorita en la escuela?  
学校で好きな科目は何ですか？  
🛏️¿A qué hora te duermes?  
何時に寝ますか？  
☀️¿Prefieres el sol o la lluvia?  
晴れと雨、どちらが好きですか？  
🍦¿Te gusta el helado?  
アイスクリームは好きですか？  
🎨¿Te gusta dibujar?  
絵を描くのは好きですか？  
🚲¿Sabes andar en bicicleta?  
自転車に乗れますか？  
🐻¿Cuál es tu animal favorito?  
好きな動物は何ですか？  
🎭¿Te gusta disfrazarte?  
仮装するのは好きですか？  
🏖️¿Prefieres la playa o la montaña?  
海と山、どちらが好きですか？  
🍌¿Te gustan los plátanos?  
バナナは好きですか？  
📱¿Tienes un teléfono?  
携帯電話を持っていますか？  
🎈¿Qué haces en tu cumpleaños?  
誕生日に何をしますか？  
🦷¿Se te ha caído algún diente?  
歯が抜けたことがありますか？  
🧩¿Te gustan los rompecabezas?  
パズルは好きですか？  
🚗¿Te gustan los coches?  
車は好きですか？  
👑¿Quién es tu superhéroe favorito?  
好きなスーパーヒーローは誰ですか？  
🎤¿Te gusta cantar?  
歌うのは好きですか？  
🧸¿Tienes un peluche favorito?  
好きなぬいぐるみはありますか？  
🍿¿Te gusta el cine?  
映画館に行くのは好きですか？  
🧁¿Prefieres pastel o galletas?  
ケーキとクッキー、どちらが好きですか？  
🚀¿Quieres viajar al espacio?  
宇宙に行きたいですか？  
🏰¿Te gustan los cuentos de hadas?  
おとぎ話は好きですか？  
🎸¿Tocas algún instrumento?  
楽器を演奏しますか？  
🌮¿Te gustan los tacos?  
タコスは好きですか？  
🎯¿Eres bueno en los juegos?  
ゲームが得意ですか？  
👟¿Te gusta correr?  
走るのは好きですか？  
🍓¿Cuál es tu fruta favorita?  
好きな果物は何ですか？  
🎲¿Te gustan los juegos de mesa?  
ボードゲームは好きですか？  
🦸‍♂️¿Qué quieres ser de grande?  
大きくなったら何になりたいですか？  
🍪¿Te gusta hornear galletas?  
クッキーを焼くのは好きですか？  
🌍¿Hablas otro idioma?  
他の言語を話しますか？  
🎪¿Te gusta el circo?  
サーカスは好きですか？  
🛒¿Te gusta ir de compras?  
買い物に行くのは好きですか？  
🎭¿Te gusta actuar?  
演技するのは好きですか？  
🦜¿Puedes imitar animales?  
動物のまねができますか？  
🎨¿Cuál es tu arte favorito?  
好きな芸術は何ですか？  
🚂¿Te gustan los trenes?  
電車は好きですか？  
🍯¿Te gusta la miel?  
はちみつは好きですか？  
🎡¿Te gusta la feria?  
遊園地は好きですか？  
🧦¿Tienes calcetines divertidos?  
面白い靴下を持っていますか？  
🎷¿Te gusta el jazz?  
ジャズは好きですか？  
🍉¿Prefieres sandía o melón?  
スイカとメロン、どちらが好きですか？  
🏆¿Has ganado un premio?  
賞をもらったことがありますか？  
🦕¿Te gustan los dinosaurios?  
恐竜は好きですか？  
🎣¿Te gusta pescar?  
釣りは好きですか？  
🍩¿Te gustan las donas?  
ドーナツは好きですか？  
🎠¿Te gustan los carruseles?  
メリーゴーランドは好きですか？  
🧀¿Te gusta el queso?  
チーズは好きですか？  
🎳¿Juegas boliche?  
ボウリングをしますか？  
🎙️¿Te gusta hablar en público?  
人前で話すのは好きですか？  
🥑¿Te gusta el aguacate?  
アボカドは好きですか？  
🎆¿Te gustan los fuegos artificiales?  
花火は好きですか？  
🧊¿Prefieres calor o frío?  
暑いのと寒いの、どちらが好きですか？  
🎄¿Te gusta la Navidad?  
クリスマスは好きですか？  
🦸‍♀️¿Tienes un poder imaginario?  
想像上の超能力はありますか？  
🍍¿Te gusta la piña?  
パイナップルは好きですか？  
🎹¿Sabes tocar el piano?  
ピアノを弾けますか？  
🏝️¿Te gustaría vivir en una isla?  
島に住みたいですか？  
🍫¿Prefieres chocolate blanco o negro?  
ホワイトチョコレートとダークチョコレート、どちらが好きですか？  
🎭¿Te gusta el teatro?  
劇場は好きですか？  
🦄¿Crees en unicornios?  
ユニコーンを信じますか？  
🎢¿Te gustan las montañas rusas?  
ジェットコースターは好きですか？  
🥞¿Te gustan los panqueques?  
パンケーキは好きですか？  
🎰¿Has jugado en un casino (de juguete)?  
(おもちゃの)カジノで遊んだことがありますか？  
🪁¿Te gusta volar cometas?  
たこを飛ばすのは好きですか？  
🎇¿Te gustan las luces brillantes?  
明るい光は好きですか？  
🍒¿Te gustan las cerezas?  
さくらんぼは好きですか？  
🎳¿Eres bueno en boliche?  
ボウリングが得意ですか？  
🛌¿Duermes con un peluche?  
ぬいぐるみと一緒に寝ますか？  
🎸¿Te gusta la guitarra?  
ギターは好きですか？  
🍄¿Te gustan los hongos?  
キノコは好きですか？  
🎲¿Te gustan los dados?  
サイコロゲームは好きですか？  
🦀¿Te gustan los cangrejos?  
カニは好きですか？  
🎧¿Escuchas música con audífonos?  
ヘッドホンで音楽を聴きますか？  
🍇¿Prefieres uvas verdes o moradas?  
緑のぶどうと紫のぶどう、どちらが好きですか？  
🎠¿Te gustan los tiovivos?  
メリーゴーランドは好きですか？  
🧃¿Prefieres jugo o leche?  
ジュースと牛乳、どちらが好きですか？  
🎯¿Eres bueno en dardos?  
ダーツが得意ですか？  
🦁¿Te gustan los leones?  
ライオンは好きですか？  
🎤¿Has cantado en un micrófono?  
マイクで歌ったことがありますか？  
🍿¿Prefieres palomitas dulces o saladas?  
甘いポップコーンと塩味のポップコーン、どちらが好きですか？  
🎨¿Pintas con acuarelas?  
水彩絵の具で絵を描きますか？  
🦉¿Te gustan los búhos?  
フクロウは好きですか？  
🎳¿Has hecho un strike en boliche?  
ボウリングでストライクを取ったことがありますか？  
🍞¿Te gusta el pan tostado?  
トーストは好きですか？  
🎸¿Tienes una banda imaginaria?  
想像上のバンドはありますか？  
🎪¿Te gustan los payasos?  
ピエロは好きですか？  
🍍¿Te gusta la piña en la pizza?  
ピザにパイナップルは好きですか？  
🎮¿Prefieres videojuegos o deportes?  
テレビゲームとスポーツ、どちらが好きですか？`,
            stories: {
                story1: `#STORY
👋 Fernando saluda a los niños.  
フェルナンドは子供たちに挨拶します。  
🍎 Fernando tiene una manzana roja.  
フェルナンドは赤いリンゴを持っています。  
👧 Emika mira la manzana.  
エミカはリンゴを見ます。  
❓ "¿Qué es esto?" pregunta Emika.  
「これは何ですか？」とエミカは尋ねます。  
🗣️ "Es una manzana," dice Fernando.  
「それはリンゴです」とフェルナンドは言います。  
😋 Emika prueba la manzana.  
エミカはリンゴを味見します。  
👍 "¡Me gusta!" dice Emika.  
「おいしい！」とエミカは言います。  
🍏 Fernando muestra una manzana verde.  
フェルナンドは緑のリンゴを見せます。  
🤔 Emika mira las dos manzanas.  
エミカは2つのリンゴを見ます。  
😊 Fernando sonríe.  
フェルナンドは微笑みます。  

#QUESTIONS
🍎 ¿Te gustan las manzanas rojas?  
赤いリンゴは好きですか？  
🍏 ¿Prefieres manzanas verdes o rojas?  
緑のリンゴと赤いリンゴ、どちらが好きですか？  
👅 ¿Quieres probar una manzana?  
リンゴを食べてみたいですか？  
🗣️ ¿Puedes decir "manzana" en español?  
スペイン語で「manzana」と言えますか？  
🎨 ¿De qué color es tu fruta favorita?  
あなたの好きな果物は何色ですか？  
😋 ¿Qué frutas te gustan?  
どんな果物が好きですか？  
👀 ¿Ves manzanas en tu escuela?  
学校でリンゴを見ますか？  
🤲 ¿Compartes comida con amigos?  
友達と食べ物を分け合いますか？  
🍎 ¿Cuántas manzanas comes cada día?  
毎日いくつリンゴを食べますか？  
😊 ¿Sonríes cuando comes algo rico?  
美味しいものを食べると笑顔になりますか？`,
                story2: `#STORY
🐶 María ve un perro pequeño.  
マリアは小さな犬を見ます。  
🏃 El perro corre rápido.  
犬は速く走ります。  
👧 María quiere acariciar al perro.  
マリアは犬を撫でたいです。  
🖐️ "¿Puedo tocar?" pregunta María.  
「触ってもいいですか？」とマリアは尋ねます。  
😊 El dueño dice "Sí."  
飼い主は「はい」と言います。  
🐕 María acaricia al perro suavemente.  
マリアは優しく犬を撫でます。  
👦 Kaito y Sorato miran.  
カイトとソラトは見ています。  
🐶 El perro mueve la cola.  
犬はしっぽを振ります。  
😄 Todos ríen.  
みんな笑います。  
❤️ A María le encantan los perros.  
マリアは犬が大好きです。  

#QUESTIONS
🐶 ¿Te gustan los perros?  
犬は好きですか？  
🐱 ¿Prefieres perros o gatos?  
犬と猫、どちらが好きですか？  
🏃 ¿Puedes correr rápido como un perro?  
犬のように速く走れますか？  
🖐️ ¿Tocas animales con cuidado?  
動物を優しく触りますか？  
🎨 ¿De qué color es tu animal favorito?  
好きな動物は何色ですか？  
😊 ¿Sonríes cuando ves un perro?  
犬を見ると笑顔になりますか？  
👀 ¿Ves perros en tu barrio?  
近所で犬を見ますか？  
🐕 ¿Tienes una mascota?  
ペットを飼っていますか？  
🤔 ¿Qué animal quieres tocar?  
どんな動物に触りたいですか？  
❤️ ¿Qué animal te encanta?  
どんな動物が大好きですか？`,
                story3: `#STORY
🎂 Es el cumpleaños de Haruki.  
ハルキの誕生日です。  
🎈 Hay globos de colores.  
色とりどりの風船があります。  
🍰 Fernando trae un pastel grande.  
フェルナンドは大きなケーキを持ってきます。  
🕯️ Siete velas están en el pastel.  
ケーキには7本のろうそくが立っています。  
👧 Emika canta "Feliz Cumpleaños."  
エミカは「ハッピーバースデー」を歌います。  
😊 Haruki sonríe mucho.  
ハルキはたくさん笑います。  
👏 Todos aplauden.  
みんな拍手します。  
🎁 Haruki abre los regalos.  
ハルキはプレゼントを開けます。  
✏️ Hay un nuevo lápiz azul.  
新しい青い鉛筆があります。  
❤️ Haruki está muy feliz.  
ハルキはとても幸せです。  

#QUESTIONS
🎂 ¿Cuándo es tu cumpleaños?  
あなたの誕生日はいつですか？  
🎈 ¿Te gustan los globos?  
風船は好きですか？  
🍰 ¿Prefieres pastel de chocolate o vainilla?  
チョコレートケーキとバニラケーキ、どちらが好きですか？  
🕯️ ¿Cuántas velas hay en tu pastel?  
あなたのケーキには何本ろうそくがありますか？  
🎁 ¿Qué regalo quieres?  
どんなプレゼントが欲しいですか？  
👏 ¿Te gusta aplaudir?  
拍手するのは好きですか？  
😊 ¿Sonríes en tu cumpleaños?  
誕生日に笑顔になりますか？  
✏️ ¿Qué color de lápiz te gusta?  
どんな色の鉛筆が好きですか？  
👫 ¿Con quién celebras tu cumpleaños?  
誰と誕生日を祝いますか？  
❤️ ¿Qué te hace feliz?  
何があなたを幸せにしますか？`,
                story4: `#STORY
☀️ Hace sol en el parque.  
公園は晴れています。  
🌳 Emika y María juegan bajo un árbol.  
エミカとマリアは木の下で遊びます。  
🦋 Una mariposa azul vuela.  
青い蝶が飛んでいます。  
👧 "¡Mira!" dice María.  
「見て！」とマリアは言います。  
🏃 Las niñas corren tras la mariposa.  
女の子たちは蝶を追いかけます。  
🌸 La mariposa se posa en una flor.  
蝶は花に止まります。  
📸 Fernando toma una foto.  
フェルナンドは写真を撮ります。  
😊 Las niñas observan en silencio.  
女の子たちは静かに観察します。  
🦋 La mariposa vuela lejos.  
蝶は飛び去ります。  
👋 "Adiós, mariposa," dicen.  
「さようなら、蝶さん」と彼女たちは言います。  

#QUESTIONS
🦋 ¿Te gustan las mariposas?  
蝶は好きですか？  
🎨 ¿Qué color de mariposa prefieres?  
どんな色の蝶が好きですか？  
🏃 ¿Corres en el parque?  
公園で走りますか？  
🌸 ¿Ves flores en el parque?  
公園で花を見ますか？  
☀️ ¿Te gusta cuando hace sol?  
晴れの日は好きですか？  
👀 ¿Qué animales ves en el parque?  
公園でどんな動物を見ますか？  
📸 ¿Te gusta tomar fotos?  
写真を撮るのは好きですか？  
😊 ¿Observas la naturaleza?  
自然を観察しますか？  
👫 ¿Con quién juegas en el parque?  
誰と公園で遊びますか？  
👋 ¿Dices "adiós" a los animales?  
動物に「さようなら」と言いますか？`,
                story5: `#STORY
📚 Fernando lee un cuento.  
フェルナンドは物語を読みます。  
👧👦 Los niños escuchan.  
子供たちは聞いています。  
🦁 El cuento es sobre un león.  
物語はライオンについてです。  
😮 Los ojos de María se abren grandes.  
マリアの目は大きく見開かれます。  
🗣️ "¡Rugido!" hace Fernando.  
「ガオー！」とフェルナンドは言います。  
😂 Todos ríen.  
みんな笑います。  
🖍️ Emika dibuja el león.  
エミカはライオンを描きます。  
🎨 Usa crayones amarillos.  
彼女は黄色のクレヨンを使います。  
👍 Fernando muestra el dibujo.  
フェルナンドは絵を見せます。  
👏 Todos aplauden.  
みんな拍手します。  

#QUESTIONS
📚 ¿Te gustan los cuentos?  
物語は好きですか？  
🦁 ¿Qué animal te gusta en los cuentos?  
物語でどんな動物が好きですか？  
🗣️ ¿Puedes hacer el sonido de un león?  
ライオンの鳴き声を出せますか？  
🎨 ¿Te gusta dibujar?  
絵を描くのは好きですか？  
🖍️ ¿Qué color usas mucho?  
よく使う色は何ですか？  
👂 ¿Escuchas cuentos en la escuela?  
学校で物語を聞きますか？  
😮 ¿Te sorprenden los cuentos?  
物語に驚きますか？  
👏 ¿Aplaudes cuando algo es bueno?  
何かが良い時に拍手しますか？  
📖 ¿Quién te lee cuentos?  
誰があなたに物語を読みますか？  
❤️ ¿Cuál es tu cuento favorito?  
好きな物語は何ですか？`,
                story6: `#STORY
🎵 Fernando toca la guitarra.  
フェルナンドはギターを弾きます。  
👧 Emika canta una canción.  
エミカは歌を歌います。  
👏 Los niños aplauden.  
子供たちは拍手します。  
🪑 María se balancea en su silla.  
マリアは椅子で揺れます。  
🎶 Kaito toca las palmas.  
カイトは手拍子をします。  
😊 Sorato sonríe y baila.  
ソラトは笑って踊ります。  
🎤 Fernando canta más fuerte.  
フェルナンドはもっと大きな声で歌います。  
👫 Todos cantan juntos.  
みんな一緒に歌います。  
🎉 Es muy divertido.  
とても楽しいです。  
❤️ A todos les encanta la música.  
みんな音楽が大好きです。  

#QUESTIONS
🎵 ¿Te gusta la música?  
音楽は好きですか？  
🎤 ¿Cantas en la escuela?  
学校で歌を歌いますか？  
👏 ¿Sigues el ritmo con palmas?  
手拍子でリズムを取りますか？  
🪑 ¿Te mueves con la música?  
音楽に合わせて動きますか？  
🎶 ¿Qué instrumento te gusta?  
どんな楽器が好きですか？  
😊 ¿Sonríes cuando escuchas música?  
音楽を聞くと笑顔になりますか？  
👫 ¿Cantas con tus amigos?  
友達と一緒に歌いますか？  
🎉 ¿Es divertido cantar?  
歌うのは楽しいですか？  
❤️ ¿Qué canción te encanta?  
どんな歌が大好きですか？  
🎵 ¿Quién toca música en tu familia?  
家族で誰が音楽を演奏しますか？`,
                story7: `#STORY
🌧️ Está lloviendo hoy.  
今日は雨が降っています。  
☔ Emika usa un paraguas amarillo.  
エミカは黄色い傘を使います。  
👢 María lleva botas de agua.  
マリアは長靴を履いています。  
💦 Los niños saltan en los charcos.  
子供たちは水たまりで跳ねます。  
😂 Fernando se ríe.  
フェルナンドは笑います。  
🌈 Aparece un arcoíris.  
虹が現れます。  
👧 "¡Mira!" grita Emika.  
「見て！」とエミカは叫びます。  
📸 Fernando toma otra foto.  
フェルナンドはもう一枚写真を撮ります。  
🌧️ La lluvia se detiene.  
雨が止みます。  
😊 Todos están contentos.  
みんな嬉しそうです。  

#QUESTIONS
🌧️ ¿Te gusta la lluvia?  
雨は好きですか？  
☔ ¿Tienes un paraguas?  
傘を持っていますか？  
👢 ¿Usas botas de agua?  
長靴を履きますか？  
💦 ¿Saltas en los charcos?  
水たまりで跳ねますか？  
🌈 ¿Has visto un arcoíris?  
虹を見たことがありますか？  
🎨 ¿Cuántos colores tiene el arcoíris?  
虹は何色ですか？  
😊 ¿Estás contento cuando sale el sol?  
太陽が出ると嬉しくなりますか？  
📸 ¿Te gusta tomar fotos de la naturaleza?  
自然の写真を撮るのは好きですか？  
👫 ¿Juegas bajo la lluvia con amigos?  
友達と雨の中で遊びますか？  
🌧️ ¿Qué haces en días lluviosos?  
雨の日には何をしますか？`,
                story8: `#STORY
🚌 Los niños van de excursión.  
子供たちは遠足に行きます。  
🏛️ Visitan un museo.  
博物館を訪れます。  
🦖 Ven dinosaurios grandes.  
大きな恐竜を見ます。  
😮 Kaito abre mucho los ojos.  
カイトは目を大きく見開きます。  
📝 Sorato escribe en su cuaderno.  
ソラトはノートに書きます。  
📸 Fernando toma muchas fotos.  
フェルナンドはたくさん写真を撮ります。  
🛍️ Emika compra un recuerdo.  
エミカはお土産を買います。  
🚌 Regresan al autobús.  
バスに戻ります。  
😴 María está cansada.  
マリアは疲れています。  
😊 Pero todos están felices.  
でもみんな幸せです。  

#QUESTIONS
🚌 ¿Te gustan las excursiones?  
遠足は好きですか？  
🏛️ ¿Qué lugar quieres visitar?  
どんな場所に行きたいですか？  
🦖 ¿Te gustan los dinosaurios?  
恐竜は好きですか？  
📝 ¿Escribes sobre tus viajes?  
旅行について書きますか？  
📸 ¿Te gusta tomar fotos en excursiones?  
遠足で写真を撮るのは好きですか？  
🛍️ ¿Compras recuerdos?  
お土産を買いますか？  
😴 ¿Te cansas en las excursiones?  
遠足で疲れますか？  
😊 ¿Qué te hace feliz en los viajes?  
旅行で何があなたを幸せにしますか？  
👫 ¿Con quién vas de excursión?  
誰と遠足に行きますか？  
🚌 ¿Qué transporte usas?  
どんな交通手段を使いますか？`,
                story9: `#STORY
🏫 Es el primer día de escuela.  
学校の初日です。  
👧 María está nerviosa.  
マリアは緊張しています。  
👦 Kaito y Sorato sonríen.  
カイトとソラトは笑っています。  
🖍️ Hay crayones nuevos.  
新しいクレヨンがあります。  
📚 Fernando muestra los libros.  
フェルナンドは本を見せます。  
🎵 Cantan una canción.  
歌を歌います。  
👫 Emika ayuda a María.  
エミカはマリアを助けます。  
😊 María ya no está nerviosa.  
マリアはもう緊張していません。  
✏️ Todos escriben sus nombres.  
みんな自分の名前を書きます。  
❤️ Es un buen primer día.  
良い初日です。  

#QUESTIONS
🏫 ¿Te gusta la escuela?  
学校は好きですか？  
🖍️ ¿Qué material escolar te gusta?  
どんな文房具が好きですか？  
📚 ¿Te gustan los libros nuevos?  
新しい本は好きですか？  
🎵 ¿Cantas en la escuela?  
学校で歌を歌いますか？  
👫 ¿Ayudas a tus compañeros?  
クラスメートを助けますか？  
😊 ¿Estabas nervioso el primer día?  
初日は緊張しましたか？  
✏️ ¿Puedes escribir tu nombre?  
自分の名前を書けますか？  
❤️ ¿Qué te gusta de la escuela?  
学校のどんなところが好きですか？  
👦 ¿Quién es tu primer amigo?  
最初の友達は誰ですか？  
🏫 ¿Qué haces en la escuela?  
学校で何をしますか？`,
                story10: `#STORY
🎄 Es Navidad.  
クリスマスです。  
🎁 Hay regalos bajo el árbol.  
木の下にプレゼントがあります。  
👧 María abre su regalo.  
マリアはプレゼントを開けます。  
🦖 ¡Es un dinosaurio de peluche!  
ぬいぐるみの恐竜です！  
❤️ María lo abraza.  
マリアはそれを抱きしめます。  
👦 Kaito recibe un balón.  
カイトはボールをもらいます。  
⚽ Sorato recibe unos guantes.  
ソラトはグローブをもらいます。  
🎶 Cantan villancicos.  
クリスマスキャロルを歌います。  
🍪 Comen galletas.  
クッキーを食べます。  
😊 Todos están felices.  
みんな幸せです。  

#QUESTIONS
🎄 ¿Te gusta la Navidad?  
クリスマスは好きですか？  
🎁 ¿Qué regalo quieres?  
どんなプレゼントが欲しいですか？  
🦖 ¿Te gustan los dinosaurios?  
恐竜は好きですか？  
❤️ ¿Abrazas tus regalos?  
プレゼントを抱きしめますか？  
🎶 ¿Cantas en Navidad?  
クリスマスに歌を歌いますか？  
🍪 ¿Qué comida te gusta en Navidad?  
クリスマスにどんな食べ物が好きですか？  
😊 ¿Estás feliz en Navidad?  
クリスマスに幸せですか？  
👫 ¿Con quién celebras?  
誰と祝いますか？  
🎄 ¿Qué ves en Navidad?  
クリスマスに何を見ますか？  
❤️ ¿Qué es lo mejor de Navidad?  
クリスマスの一番良いところは何ですか？`
            }
        };

        // Global variables
        let currentContentType = null;
        let currentStory = null;
        let sentences = [];
        let currentSentenceIndex = 0;
        let fruitGameEnabled = false;
        let fruitGameActive = false;
        let shouldAdvanceAfterGame = false;
        let isNightMode = false;

        // DOM elements
        const mainContainer = document.getElementById('mainContainer');
        const readingModeContainer = document.getElementById('readingModeContainer');
        const spanishSentence = document.getElementById('spanishSentence');
        const japaneseSentence = document.getElementById('japaneseSentence');
        const prevSentenceBtn = document.getElementById('prevSentence');
        const nextSentenceBtn = document.getElementById('nextSentence');
        const playSpanishBtn = document.getElementById('playSpanish');
        const playJapaneseBtn = document.getElementById('playJapanese');
        const exitReadingBtn = document.getElementById('exitReading');
        const fruitToggleBtn = document.getElementById('fruitToggle');
        const contentSelector = document.getElementById('contentSelector');
        const storySelector = document.getElementById('storySelector');
        const nightModeToggle = document.getElementById('nightModeToggle');
        
        // Initialize the app
        function init() {
            // Set up event listeners
            contentSelector.addEventListener('change', handleContentSelect);
            storySelector.addEventListener('change', handleStorySelect);

            nightModeToggle.addEventListener('click', toggleNightMode);
            prevSentenceBtn.addEventListener('click', showPreviousSentence);
            nextSentenceBtn.addEventListener('click', showNextSentence);
            playSpanishBtn.addEventListener('click', () => playSentence('spanish'));
            playJapaneseBtn.addEventListener('click', () => playSentence('japanese'));
            exitReadingBtn.addEventListener('click', exitReadingMode);
            fruitToggleBtn.addEventListener('click', toggleFruitGame);

            // Initialize translation elements
            initTranslationElements();
            
            // Set up keyboard navigation for TV remote
            document.addEventListener('keydown', handleRemoteInput);
            
            // Load voices when they become available
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = function() {
                    console.log('Voices loaded');
                };
                
                // Some browsers need this to load voices
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.getVoices();
                }
            }
            
            // Focus the content selector
            contentSelector.focus();
        }
        
        function updatePageCounter() {
            if (!sentences || sentences.length === 0) return;
            
            document.getElementById('currentPage').textContent = currentSentenceIndex + 1;
            document.getElementById('totalPages').textContent = sentences.length;
        }

        function toggleNightMode() {
            isNightMode = !isNightMode;
            document.body.classList.toggle('dark-mode', isNightMode);
            nightModeToggle.textContent = isNightMode ? '☀️' : '🌙';
            
            // Save preference to localStorage
            localStorage.setItem('nightMode', isNightMode);
        }
        
        function handleContentSelect() {
            currentContentType = this.value;
            storySelector.disabled = (currentContentType !== 'stories');
            
            if (currentContentType === 'stories') {
                populateStorySelector();
            } else if (currentContentType === 'questions') {
                // Enter reading mode for questions
                enterReadingMode();
            } else {
                storySelector.innerHTML = '<option value="">ストーリーを選択</option>';
                storySelector.disabled = true;
            }
        }
        
        function handleStorySelect() {
            currentStory = this.value;
            
            if (currentStory) {
                enterReadingMode();
            }
        }
        
        function populateStorySelector() {
            storySelector.innerHTML = '<option value="">ストーリーを選択</option>';
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = `story${i}`;
                option.textContent = `ストーリー ${i}`;
                storySelector.appendChild(option);
            }
            storySelector.disabled = false;
            storySelector.focus();
        }
        
        // Enter reading mode
        function enterReadingMode() {
            // Hide main container and show reading container
            mainContainer.style.display = 'none';
            readingModeContainer.style.display = 'flex';
            
            // Initialize translation events
            initTranslationEvents();
            
            // Load the content
            loadTextContent();
        }
        
        // Exit reading mode
        function exitReadingMode() {
            // Show main container and hide reading container
            mainContainer.style.display = 'block';
            readingModeContainer.style.display = 'none';
            
            // Stop any speech
            stopSpeech();
            
            // Focus the content selector
            setTimeout(() => {
                contentSelector.focus();
            }, 100);
        }
        
        // Load text content for reading mode
        function loadTextContent() {
            let content;
            if (currentContentType === 'questions') {
                content = spanishContent.questions;
            } else if (currentContentType === 'stories' && currentStory) {
                content = spanishContent.stories[currentStory];
            } else {
                alert('コンテンツが利用できません');
                exitReadingMode();
                return;
            }

            sentences = parseStoryFile(content);
            if (sentences.length > 0) {
                currentSentenceIndex = 0;
                updatePageCounter();
                displayCurrentSentence();
            } else {
                alert('文が見つかりません');
                exitReadingMode();
            }
        }
        
        // Parse story file content
function parseStoryFile(text) {
    const lines = text.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && !line.startsWith('#'));
    
    const result = [];
    let spanishLine = null;
    
    for (const line of lines) {
        // Spanish line has emojis or Spanish characters
        if (/[a-zA-ZáéíóúÁÉÍÓÚñÑ¿¡]/.test(line)) {
            spanishLine = line;
        } 
        // Japanese line (any line that's not Spanish and not empty)
        else if (spanishLine) {
            result.push({
                spanish: spanishLine,
                japanese: line,
                number: result.length + 1
            });
            spanishLine = null;
        }
    }
    
    return result;
}
        
        function ensureTextVisibility() {
            const rows = document.querySelectorAll('.sentence-row');
            rows.forEach(row => {
                const display = row.querySelector('.sentence-display');
                if (display.scrollHeight > display.clientHeight) {
                    // Reduce font size until text fits
                    let fontSize = parseFloat(window.getComputedStyle(display).fontSize);
                    while (display.scrollHeight > display.clientHeight && fontSize > 24) {
                        fontSize -= 1;
                        display.style.fontSize = `${fontSize}px`;
                    }
                }
            });
        }
        
        // Display current sentence
        function displayCurrentSentence() {
            if (!sentences || sentences.length === 0) {
                spanishSentence.textContent = "文が読み込まれていません";
                japaneseSentence.textContent = "";
                return;
            }

            const sentence = sentences[currentSentenceIndex];
            
            // Remove emoji from display if it's at the start of the sentence
            let spanishText = sentence.spanish;
            const emojiRegex = /^(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u;
            if (emojiRegex.test(spanishText)) {
                // Find the first emoji character
                const emojiMatch = spanishText.match(emojiRegex);
                if (emojiMatch && emojiMatch[0]) {
                    spanishText = spanishText.substring(emojiMatch[0].length).trim();
                }
            }
            
            spanishSentence.textContent = `${sentence.number}. ${spanishText}`;
            japaneseSentence.textContent = `${sentence.number}. ${sentence.japanese}`;
            
            // Update button states - Never disable navigation buttons
            prevSentenceBtn.disabled = false;
            nextSentenceBtn.disabled = false;
            setTimeout(ensureTextVisibility, 50);
            updatePageCounter(); 
        }
        
        // Play sentence audio
        function playSentence(type) {
            if (sentences.length === 0 || fruitGameActive) return;
            
            const sentence = sentences[currentSentenceIndex];
            let text = type === 'spanish' ? sentence.spanish : sentence.japanese;
            const lang = type === 'spanish' ? 'es-ES' : 'ja-JP';
            
            // Remove emoji from text to be spoken
            const emojiRegex = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
            text = text.replace(emojiRegex, '').trim();
            
            // Stop any current speech and sounds
            stopSpeech();
            
            // Speak the sentence
            speakSentence(text, lang);
        }
        
        function stopSpeech() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }    
        
        // Text-to-speech function
        function speakSentence(text, lang) {
            if (!('speechSynthesis' in window)) {
                console.warn('音声合成がサポートされていません');
                return;
            }

            // Stop any current speech
            stopSpeech();

            // Create new utterance
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Set language and voice properties
            utterance.lang = lang;
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            // Function to actually speak once voices are loaded
            const speakWithVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                
                // Find the appropriate voice
                let voice;
                if (lang === 'es-ES') {
                    // Find a Spanish voice
                    voice = voices.find(v => 
                        v.lang === 'es-ES' || 
                        v.lang.startsWith('es')
                    );
                } else if (lang === 'ja-JP') {
                    // Find a Japanese voice
                    voice = voices.find(v => 
                        v.lang === 'ja-JP' || 
                        v.lang.startsWith('ja')
                    );
                }

                if (voice) {
                    utterance.voice = voice;
                    console.log('Using voice:', voice.name, 'for language:', lang);
                } else {
                    console.warn('No specific voice found for', lang, 'using default');
                }

                // Error handling
                utterance.onerror = function(event) {
                    console.error('SpeechSynthesis error:', event);
                };

                // Speak immediately
                window.speechSynthesis.speak(utterance);
            };

            // Check if voices are loaded
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                console.log('Waiting for voices to load...');
                window.speechSynthesis.onvoiceschanged = speakWithVoice;
            } else {
                speakWithVoice();
            }
        }
        
        // Navigation functions
        function showNextSentence() {
            stopSpeech();
            closeTranslationPopupHandler();
            
            if (sentences.length === 0 || fruitGameActive) return;
            
            const isLastPage = currentSentenceIndex >= sentences.length - 1;
            
            // Always allow fruit game if enabled
            if (fruitGameEnabled) {
                shouldAdvanceAfterGame = true; // Always set to true - we'll handle last page in hideFruitGame
                showFruitGame();
                return;
            }
            
            // Handle last page case (only when fruit game is off)
            if (isLastPage) {
                currentSentenceIndex = 0; // Loop to beginning
                displayCurrentSentence();
                return;
            }
            
            // Normal case - go to next sentence
            advanceToNextSentence();
        }
        
        function advanceToNextSentence() {
            if (currentSentenceIndex < sentences.length - 1) {
                currentSentenceIndex++;
            } else {
                currentSentenceIndex = 0; // Loop to beginning
            }
            
            displayCurrentSentence();
            updatePageCounter();
        }
        
        function showPreviousSentence() {
            stopSpeech();
            closeTranslationPopupHandler(); // Close any open translation popup
            
            if (sentences.length === 0) return;
            
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
            } else {
                currentSentenceIndex = sentences.length - 1; // Loop to end
            }
            
            displayCurrentSentence();
            updatePageCounter(); 
        }
        
        // Handle TV remote input
        function handleRemoteInput(e) {
            const activeElement = document.activeElement;
            
            switch(e.key) {
                case 'ArrowUp':
                    navigateFocus('up');
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    navigateFocus('down');
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (activeElement === prevSentenceBtn) {
                        showPreviousSentence();
                    } else {
                        navigateFocus('left');
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (activeElement === nextSentenceBtn) {
                        showNextSentence();
                    } else {
                        navigateFocus('right');
                    }
                    e.preventDefault();
                    break;
                case 'Enter':
                    if (activeElement) {
                        activeElement.click();
                    }
                    break;
                case 'Backspace':
                    exitReadingMode();
                    break;
            }
        }
        
        // Navigate focus between elements
        function navigateFocus(direction) {
            const focusable = Array.from(document.querySelectorAll('button, select, [tabindex="0"]'));
            const currentIndex = focusable.indexOf(document.activeElement);
            
            if (currentIndex === -1) {
                if (focusable.length > 0) focusable[0].focus();
                return;
            }
            
            let nextIndex = currentIndex;
            
            // Simple navigation - can be enhanced for grid layouts
            if (direction === 'up' || direction === 'left') {
                nextIndex = Math.max(0, currentIndex - 1);
            } else {
                nextIndex = Math.min(focusable.length - 1, currentIndex + 1);
            }
            
            focusable[nextIndex].focus();
        }
        
        // Translation state variables
        let translationPopup, translationOverlay, closeTranslationPopup;
        let translationOriginal, translationResult, translationTts;
        let selectedText = '';
        let translationLang = '';

        // Initialize translation elements
        function initTranslationElements() {
            translationPopup = document.getElementById('translationPopup');
            translationOverlay = document.getElementById('translationOverlay');
            closeTranslationPopup = document.getElementById('closeTranslationPopup');
            translationOriginal = document.getElementById('translationOriginal');
            translationResult = document.getElementById('translationResult');
            translationTts = document.getElementById('translationTts');
            
            if (!translationPopup || !translationOverlay || !closeTranslationPopup || 
                !translationOriginal || !translationResult || !translationTts) {
                console.error('翻訳要素が見つかりません');
                return false;
            }
            
            // Reset state
            selectedText = '';
            translationLang = '';
            return true;
        }

        // Show translation popup
        function showTranslationPopup(text, lang) {
            // Validate input
            const trimmedText = text.trim();
            if (!trimmedText || trimmedText.length < 1 || trimmedText.toLowerCase() === 'translate') {
                return;
            }
            
            // Reset previous state
            closeTranslationPopupHandler();
            
            // Set new translation data
            selectedText = trimmedText;
            translationLang = lang;
            
            // Update UI labels based on translation direction
            const sourceLabel = document.getElementById('sourceLanguageLabel');
            const targetLabel = document.getElementById('targetLanguageLabel');
            
            if (lang === 'es') {
                sourceLabel.textContent = 'スペイン語:';
                targetLabel.textContent = '日本語:';
            } else {
                sourceLabel.textContent = '日本語:';
                targetLabel.textContent = 'スペイン語:';
            }
            
            // Highlight the selected text
            try {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'highlighted-text';
                    span.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                    range.surroundContents(span);
                }
            } catch (e) {
                console.error('テキストのハイライト中にエラー:', e);
            }
            
            // Update UI with original text
            translationOriginal.textContent = selectedText;
            translationResult.textContent = "翻訳を読み込み中...";
            
            // Show popup
            translationPopup.classList.add('active');
            translationOverlay.classList.add('active');
            
            // Fetch translation
            fetchTranslation(selectedText, lang);
            
            // Add event listener to close popup when clicking Next button
            const nextBtn = document.getElementById('nextSentence');
            const prevBtn = document.getElementById('prevSentence');
            
            const closeOnNav = () => {
                closeTranslationPopupHandler();
                nextBtn.removeEventListener('click', closeOnNav);
                prevBtn.removeEventListener('click', closeOnNav);
            };
            
            nextBtn.addEventListener('click', closeOnNav);
            prevBtn.addEventListener('click', closeOnNav);
        }

        function closeTranslationPopupHandler() {
            if (!translationPopup || !translationOverlay) return;
            
            translationPopup.classList.remove('active');
            translationOverlay.classList.remove('active');
            stopSpeech();
            
            // Clear the translation fields
            translationOriginal.textContent = '';
            translationResult.textContent = '';
            
            // Reset selection state
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
            
            // Remove all highlights and restore original text
            document.querySelectorAll('.highlighted-text').forEach(el => {
                const parent = el.parentNode;
                while (el.firstChild) {
                    parent.insertBefore(el.firstChild, el);
                }
                parent.removeChild(el);
                parent.normalize(); // Combine adjacent text nodes
            });
            
            // Reset translation variables
            selectedText = '';
            translationLang = '';
        }

        // Fetch translation from a free API
        function fetchTranslation(text, lang) {
            // Correct format is "es|ja" or "ja|es"
            const langPair = lang === 'es' ? 'es|ja' : 'ja|es';
            
            // Encode the text and language pair properly
            const encodedText = encodeURIComponent(text);
            const encodedLangPair = encodeURIComponent(langPair);
            
            // Build the API URL
            const apiUrl = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${encodedLangPair}`;
            
            // Use a reliable CORS proxy
            const proxyUrl = 'https://corsproxy.io/?';
            
            fetch(proxyUrl + apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ネットワーク応答が正常ではありませんでした');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.responseData && data.responseData.translatedText) {
                        // Clean the translated text
                        let translatedText = data.responseData.translatedText;
                        
                        // Remove unwanted characters and formatting
                        translatedText = translatedText
                            .replace(/[#*_~`^]/g, '') // Remove special formatting chars
                            .replace(/\{.*?\}/g, '')   // Remove {tags}
                            .replace(/\[.*?\]/g, '')   // Remove [tags]
                            .replace(/\(.*?\)/g, '')   // Remove (tags)
                            .replace(/\d+/g, '')       // Remove numbers
                            .trim();
                        
                        // If the result is empty after cleaning, show an error
                        if (!translatedText) {
                            throw new Error('翻訳が空でした');
                        }
                        
                        translationResult.textContent = translatedText;
                    } else {
                        throw new Error('翻訳データがありませんでした');
                    }
                })
                .catch(error => {
                    console.error('翻訳エラー:', error);
                    translationResult.textContent = "翻訳を取得できませんでした";
                });
        }
        
        // Handle text selection - CORRECTED VERSION
        function handleTextSelection() {
            try {
                const selection = window.getSelection();
                if (!selection || selection.isCollapsed || selection.rangeCount === 0) {
                    return;
                }

                const selectedText = selection.toString().trim();
                if (!selectedText || selectedText.length < 1 || selectedText.toLowerCase() === 'translate') {
                    return;
                }

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;

                // Check if selection is within our target elements
                const isSpanish = spanishSentence.contains(container);
                const isJapanese = japaneseSentence.contains(container);
                if (!isSpanish && !isJapanese) {
                    closeTranslationPopupHandler();
                    return;
                }

                // Skip if selection is collapsed (no actual text)
                if (range.collapsed) {
                    closeTranslationPopupHandler();
                    return;
                }

                // Show translation immediately for the selected text
                showTranslationPopup(selectedText, isSpanish ? 'es' : 'ja');
            } catch (error) {
                console.error('テキスト選択処理中にエラーが発生しました:', error);
            }
        }
        
        function initTranslationEvents() {
            // Initialize translation elements first
            if (!initTranslationElements()) return;

            // Click event for single words
            spanishSentence.addEventListener('click', handleSpanishClick);
            japaneseSentence.addEventListener('click', handleJapaneseClick);
            
            // Selection event for phrases
            document.addEventListener('mouseup', handleTextSelection);
            
            // Close popup events
            closeTranslationPopup.addEventListener('click', closeTranslationPopupHandler);
            translationOverlay.addEventListener('click', closeTranslationPopupHandler);
            
            // TTS button
            translationTts.addEventListener('click', () => {
                if (selectedText && translationLang) {
                    speakSentence(selectedText, translationLang === 'es' ? 'es-ES' : 'ja-JP');
                }
            });
        }

        function handleSpanishClick(e) {
            if (e.target === spanishSentence) {
                const word = getWordAtPoint(spanishSentence, e.clientX, e.clientY);
                if (word) {
                    showTranslationPopup(word, 'es');
                }
            }
        }

        function handleJapaneseClick(e) {
            if (e.target === japaneseSentence) {
                const word = getWordAtPoint(japaneseSentence, e.clientX, e.clientY);
                if (word) {
                    showTranslationPopup(word, 'ja');
                }
            }
        }

        // Helper function to get word at specific coordinates
        function getWordAtPoint(element, x, y) {
            const range = document.caretRangeFromPoint(x, y);
            if (!range) return null;
            
            range.expand('word');
            const word = range.toString().trim();
            return word || null;
        }
        
        // Fruit game categories - ALL IN SPANISH
        const categories = [
            { 
                name: 'Frutas', 
                items: [
                    {emoji: '🍎', name: 'Manzana'}, 
                    {emoji: '🍊', name: 'Naranja'},
                    {emoji: '🍇', name: 'Uvas'},
                    {emoji: '🍋', name: 'Limón'},
                    {emoji: '🍉', name: 'Sandía'},
                    {emoji: '🍓', name: 'Fresa'},
                    {emoji: '🍒', name: 'Cereza'},
                    {emoji: '🍑', name: 'Melocotón'},
                    {emoji: '🍍', name: 'Piña'},
                    {emoji: '🥝', name: 'Kiwi'}
                ]
            },
            { 
                name: 'Verduras', 
                items: [
                    {emoji: '🥕', name: 'Zanahoria'},
                    {emoji: '🥦', name: 'Brócoli'},
                    {emoji: '🍅', name: 'Tomate'},
                    {emoji: '🥒', name: 'Pepino'},
                    {emoji: '🌽', name: 'Maíz'},
                    {emoji: '🍆', name: 'Berenjena'},
                    {emoji: '🥬', name: 'Lechuga'},
                    {emoji: '🧅', name: 'Cebolla'},
                    {emoji: '🧄', name: 'Ajo'},
                    {emoji: '🥔', name: 'Papa'}
                ]
            },
            { 
                name: 'Naturaleza', 
                items: [
                    {emoji: '🌲', name: 'Árbol'},
                    {emoji: '🌵', name: 'Cactus'},
                    {emoji: '🌊', name: 'Ola'},
                    {emoji: '⛰️', name: 'Montaña'},
                    {emoji: '🌋', name: 'Volcán'},
                    {emoji: '🏝️', name: 'Isla'},
                    {emoji: '🌅', name: 'Amanecer'},
                    {emoji: '🌈', name: 'Arcoíris'},
                    {emoji: '❄️', name: 'Copo de nieve'},
                    {emoji: '🌪️', name: 'Tornado'}
                ]
            },
            { 
                name: 'Animales', 
                items: [
                    {emoji: '🐶', name: 'Perro'},
                    {emoji: '🐱', name: 'Gato'},
                    {emoji: '🦁', name: 'León'},
                    {emoji: '🐯', name: 'Tigre'},
                    {emoji: '🦊', name: 'Zorro'},
                    {emoji: '🐻', name: 'Oso'},
                    {emoji: '🐼', name: 'Panda'},
                    {emoji: '🐨', name: 'Koala'},
                    {emoji: '🐵', name: 'Mono'},
                    {emoji: '🦄', name: 'Unicornio'}
                ]
            },
            { 
                name: 'Comida', 
                items: [
                    {emoji: '🍕', name: 'Pizza'},
                    {emoji: '🍔', name: 'Hamburguesa'},
                    {emoji: '🌭', name: 'Perrito caliente'},
                    {emoji: '🍟', name: 'Papas fritas'},
                    {emoji: '🍣', name: 'Sushi'},
                    {emoji: '🍩', name: 'Dona'},
                    {emoji: '🍪', name: 'Galleta'},
                    {emoji: '🍿', name: 'Palomitas'},
                    {emoji: '🍦', name: 'Helado'},
                    {emoji: '🍫', name: 'Chocolate'}
                ]
            },
            { 
                name: 'Deportes', 
                items: [
                    {emoji: '⚽', name: 'Fútbol'},
                    {emoji: '🏀', name: 'Baloncesto'},
                    {emoji: '🏈', name: 'Fútbol americano'},
                    {emoji: '⚾', name: 'Béisbol'},
                    {emoji: '🎾', name: 'Tenis'},
                    {emoji: '🏐', name: 'Voleibol'},
                    {emoji: '🎱', name: 'Billar'},
                    {emoji: '🏓', name: 'Ping Pong'},
                    {emoji: '🏸', name: 'Bádminton'},
                    {emoji: '🥊', name: 'Boxeo'}
                ]
            },
            { 
                name: 'Vehículos', 
                items: [
                    {emoji: '🚗', name: 'Coche'},
                    {emoji: '🚕', name: 'Taxi'},
                    {emoji: '🚙', name: 'Camioneta'},
                    {emoji: '🚌', name: 'Autobús'},
                    {emoji: '🚑', name: 'Ambulancia'},
                    {emoji: '🚒', name: 'Camión de bomberos'},
                    {emoji: '🚜', name: 'Tractor'},
                    {emoji: '🚲', name: 'Bicicleta'},
                    {emoji: '🛵', name: 'Scooter'},
                    {emoji: '✈️', name: 'Avión'}
                ]
            },
            { 
                name: 'Hogar', 
                items: [
                    {emoji: '🛏️', name: 'Cama'},
                    {emoji: '🛋️', name: 'Sofá'},
                    {emoji: '🚪', name: 'Puerta'},
                    {emoji: '🪑', name: 'Silla'},
                    {emoji: '🛁', name: 'Bañera'},
                    {emoji: '🚿', name: 'Ducha'},
                    {emoji: '🧻', name: 'Papel higiénico'},
                    {emoji: '🧹', name: 'Escoba'},
                    {emoji: '🧴', name: 'Loción'},
                    {emoji: '🔪', name: 'Cuchillo de cocina'}
                ]
            },
            { 
                name: 'Ropa', 
                items: [
                    {emoji: '👕', name: 'Camiseta'},
                    {emoji: '👖', name: 'Vaqueros'},
                    {emoji: '🧥', name: 'Abrigo'},
                    {emoji: '👗', name: 'Vestido'},
                    {emoji: '👔', name: 'Corbata'},
                    {emoji: '👚', name: 'Blusa'},
                    {emoji: '👟', name: 'Zapatillas'},
                    {emoji: '🧦', name: 'Calcetines'},
                    {emoji: '🧤', name: 'Guantes'},
                    {emoji: '🎩', name: 'Sombrero de copa'}
                ]
            },
            { 
                name: 'Electrónicos', 
                items: [
                    {emoji: '📱', name: 'Teléfono móvil'},
                    {emoji: '💻', name: 'Ordenador portátil'},
                    {emoji: '🖥️', name: 'Ordenador de sobremesa'},
                    {emoji: '🖨️', name: 'Impresora'},
                    {emoji: '📷', name: 'Cámara'},
                    {emoji: '🎥', name: 'Videocámara'},
                    {emoji: '📺', name: 'Televisor'},
                    {emoji: '🎮', name: 'Mando de juego'},
                    {emoji: '⌚', name: 'Reloj'},
                    {emoji: '🔌', name: 'Enchufe'}
                ]
            }
        ];

        // Fruit game functions
        function updateFruitButtonState() {
            fruitToggleBtn.textContent = fruitGameEnabled ? '🎰 フルーツゲーム ON' : '🎰 フルーツゲーム OFF';
            fruitToggleBtn.classList.toggle('on', fruitGameEnabled);
        }
        
        function toggleFruitGame() {
            fruitGameEnabled = !fruitGameEnabled;
            updateFruitButtonState();
            
            if (fruitGameEnabled) {
                playSound('activate');
                if (navigator.vibrate) navigator.vibrate(50);
            }
            
            console.log('フルーツゲーム:', fruitGameEnabled ? 'ON' : 'OFF');
        }
        
        function showFruitGame() {
            if (!fruitGameEnabled || fruitGameActive) {
                console.log('フルーツゲームが表示されません - 有効:', fruitGameEnabled, 'アクティブ:', fruitGameActive);
                return;
            }
            
            // Stop any current speech
            stopSpeech();
            fruitGameActive = true;
            
            // Create game container
            const gameContainer = document.createElement('div');
            gameContainer.className = 'fruit-game-container';
            gameContainer.innerHTML = `
                <div class="fruit-game">
                    <h2 class="japanese-font">フルーツマシン！</h2>
                    <div class="fruit-reels">
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel1">🍎</div>
                            <div class="fruit-name" id="name1"></div>
                        </div>
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel2">🍊</div>
                            <div class="fruit-name" id="name2"></div>
                        </div>
                        <div class="reel-container">
                            <div class="fruit-reel" id="reel3">🍇</div>
                            <div class="fruit-name" id="name3"></div>
                        </div>
                    </div>
                    <div id="fruitResult" class="japanese-font" style="font-size: 2rem; min-height: 60px; margin: 20px 0;"></div>
                    <button id="exitFruitGame" class="btn japanese-font" style="margin-top: 20px; background-color: var(--warning);">終了</button>
                </div>
            `;
            
            document.body.appendChild(gameContainer);
            
            // Spin the reels
            spinReels();
            
            // Exit button
            document.getElementById('exitFruitGame').addEventListener('click', hideFruitGame);
        }
        
        function hideFruitGame() {
            const game = document.querySelector('.fruit-game-container');
            if (game) game.remove();
            fruitGameActive = false;
            
            // Stop any game sounds
            if (window.AudioContext) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.close();
            }
            
            // Ensure translation popup is closed
            closeTranslationPopupHandler();
            
            setTimeout(() => {
                if (shouldAdvanceAfterGame) {
                    const isLastPage = currentSentenceIndex >= sentences.length - 1;
                    if (isLastPage) {
                        // If we're on last page, loop back to first page
                        currentSentenceIndex = 0;
                    } else {
                        // Otherwise just go to next page
                        advanceToNextSentence();
                    }
                    shouldAdvanceAfterGame = false;
                }
                displayCurrentSentence(); // Always refresh display
            }, 500);
        }
        
        function spinReels() {
            // Select a random category for this spin
            const currentCategory = categories[Math.floor(Math.random() * categories.length)];
            const items = currentCategory.items;
            
            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3')
            ];
            const resultDisplay = document.getElementById('fruitResult');
            
            // Reset display
            resultDisplay.textContent = '';
            resultDisplay.style.color = '';
            
            // Play spinning sound
            playSound('spin');
            
            // Determine if we should have a match (1 in 3 chance)
            const shouldMatch = Math.random() < 0.33;
            let matchingItem = '';
            
            if (shouldMatch) {
                matchingItem = items[Math.floor(Math.random() * items.length)];
                // Update the matchingItem to be the full object (not just emoji)
                matchingItem = items.find(item => item.emoji === matchingItem.emoji) || matchingItem;
            }
            
            // Spin each reel with delays between them
            spinReel(reels[0], 0, items, matchingItem, shouldMatch, () => {
                playSound('reelStop');
                spinReel(reels[1], 300, items, matchingItem, shouldMatch, () => {
                    playSound('reelStop');
                    spinReel(reels[2], 300, items, matchingItem, shouldMatch, () => {
                        playSound('reelStop');
                        
                        // Check for win after last reel stops
                        setTimeout(() => {
                            if (shouldMatch && reels[0].textContent === reels[1].textContent && 
                                reels[1].textContent === reels[2].textContent) {
                                // Win condition
                                playSound('win');
                                playSound('coin');
                                resultDisplay.textContent = '🎉 当たり！ 🎉';
                                resultDisplay.style.color = 'var(--success)';
                                resultDisplay.style.fontWeight = 'bold';
                                
                                // Celebration animation
                                reels.forEach(reel => {
                                    reel.style.transform = 'scale(1.2)';
                                    reel.style.transition = 'all 0.3s';
                                    reel.style.boxShadow = '0 0 20px gold';
                                });
                                
                                // Confetti effect
                                setTimeout(() => {
                                    createConfetti();
                                }, 500);
                                
                                setTimeout(hideFruitGame, 3000);
                            } else {
                                // Lose condition
                                playSound('lose');
                                resultDisplay.textContent = 'もう一度！';
                                resultDisplay.style.color = 'var(--warning)';
                                
                                // Shake animation
                                reels.forEach(reel => {
                                    reel.style.animation = 'shake 0.5s';
                                });
                                
                                setTimeout(hideFruitGame, 2000);
                            }
                        }, 300);
                    });
                });
            });
        }
        
        // Helper function to spin a single reel
        function spinReel(reel, delay, items, matchingItem, shouldMatch, callback) {
            const reelNumber = reel.id.replace('reel', '');
            const nameElement = document.getElementById(`name${reelNumber}`);
            
            setTimeout(() => {
                let spins = 0;
                const spinInterval = setInterval(() => {
                    // For the first few spins, show random items
                    if (spins < 10) {
                        const randomItem = items[Math.floor(Math.random() * items.length)];
                        reel.textContent = randomItem.emoji;
                        nameElement.textContent = '';
                    } 
                    // Then slow down to the final result
                    else if (spins < 15) {
                        if (spins % 2 === 0) {
                            const randomItem = items[Math.floor(Math.random() * items.length)];
                            reel.textContent = randomItem.emoji;
                            nameElement.textContent = '';
                        }
                    } 
                    // Final result
                    else {
                        clearInterval(spinInterval);
                        let finalItem;
                        if (shouldMatch) {
                            finalItem = matchingItem;
                        } else {
                            finalItem = items[Math.floor(Math.random() * items.length)];
                        }
                        reel.textContent = finalItem.emoji;
                        nameElement.textContent = finalItem.name;
                        
                        // Speak the name
                        if (window.speechSynthesis) {
                            const utterance = new SpeechSynthesisUtterance(finalItem.name);
                            utterance.lang = 'es-ES';
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        }
                        
                        if (callback) callback();
                    }
                    spins++;
                }, 100);
            }, delay);
        }
        
        // Confetti effect for wins
        function createConfetti() {
            const container = document.querySelector('.fruit-game-container');
            if (!container) return;
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.borderRadius = '50%';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-10px';
                confetti.style.opacity = '0.8';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;
                
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Play sound effects
        function playSound(type) {
            if (!window.AudioContext) return;
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let oscillator = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            // Different sounds for different events
            switch(type) {
                case 'spin':
                    // Continuous spinning sound
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.8);
                    break;
                    
                case 'reelStop':
                    // Short click when a reel stops
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                    
                case 'win':
                    // Winning fanfare
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                    oscillator.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.3); // C6
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    break;
                    
                case 'lose':
                    // Sad trombone
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(349.23, audioCtx.currentTime); // F4
                    oscillator.frequency.exponentialRampToValueAtTime(261.63, audioCtx.currentTime + 0.5); // C4
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.6);
                    break;
                    
                case 'activate':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(784, audioCtx.currentTime); // G5
                    oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.2); // C6
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                    
                case 'coin':
                    // Coin sound for wins
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(988, audioCtx.currentTime); // B5
                    oscillator.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1); // E6
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                    break;
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', function() {
            // Check for saved night mode preference
            const savedNightMode = localStorage.getItem('nightMode') === 'true';
            if (savedNightMode) {
                isNightMode = true;
                document.body.classList.add('dark-mode');
                nightModeToggle.textContent = '☀️';
            }
            
            init();
        });
    </script>
</body>
</html>
